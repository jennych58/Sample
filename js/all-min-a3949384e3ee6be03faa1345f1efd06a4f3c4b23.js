var basemapGallery,icmBasemap;
function initBasemapGallery(){require("esri/dijit/BasemapGallery esri/arcgis/utils dojo/parser dijit/layout/BorderContainer dijit/layout/ContentPane dijit/TitlePane dojo/domReady!".split(" "),function(a,b,c){c.parse();icmBasemap=new esri.dijit.Basemap({layers:[layers.basemap],title:"UCSB Basemap",thumbnailUrl:"/images/basemapimages/basemap_default.png"});layers.aerialimagery2012=initJSONLayer(layersConfig.aerialimagery2012);b=new esri.dijit.Basemap({layers:[layers.aerialimagery2012],title:"2012 Aerial",
thumbnailUrl:"/images/basemapimages/basemap_aerial2012.png"});layers.aerialimagery2010=initJSONLayer(layersConfig.aerialimagery2010);c=new esri.dijit.Basemap({layers:[layers.aerialimagery2010],title:"2010 Aerial",thumbnailUrl:"/images/basemapimages/basemap_aerial2010.png"});layers.aerialimagery2006=initJSONLayer(layersConfig.aerialimagery2006);var d=new esri.dijit.Basemap({layers:[layers.aerialimagery2006],title:"2006 Aerial",thumbnailUrl:"/images/basemapimages/basemap_aerial2006.png"});basemapGallery=
new a({showArcGISBasemaps:!0,map:map,basemaps:[icmBasemap,b,c,d],showArcGISBasemaps:!1},"basemapGallery");basemapGallery.startup();basemapGallery.on("error",function(a){console.log("basemap gallery error:  ",a)});console.log("Basemap gallery loaded!")})}var geoLocate,home;
function initGeolocation(a){require(["esri/dijit/LocateButton","esri/dijit/HomeButton","dojo/domReady!"],function(b,c){geoLocate=new b({map:a},"LocateButton");geoLocate.startup();home=new c({map:a},"HomeButton");home.startup()})}dojo.require("dojo._base.array");dojo.require("dojo.json");dojo.require("dijit.layout.BorderContainer");dojo.require("dijit.layout.ContentPane");dojo.require("dijit.layout.AccordionContainer");dojo.require("dijit.layout.TabContainer");dojo.require("dijit.form.Form");dojo.require("dijit.form.TextBox");
dojo.require("dijit.Toolbar");dojo.require("dijit.Tree");dojo.require("dijit.Dialog");dojo.require("dijit.form.Button");dojo.require("esri.map");dojo.require("esri.dijit.Scalebar");dojo.require("esri.dijit.Legend");"mobile"==user_device||"tablet"==user_device?dojo.require("esri.dijit.PopupMobile"):dojo.require("esri.dijit.Popup");dojo.require("esri.dijit.InfoWindow");dojo.require("dojo.data.ItemFileReadStore");dojo.require("dijit.form.FilteringSelect");dojo.require("esri.tasks.query");dojo.require("esri.layers.KMLLayer");
var map,layers=[],layersActive=[],legendLayers=[],legend=[],benchmark=[];benchmark.startTime=(new Date).getTime();
function init(){campusExtent=new esri.geometry.Extent({xmin:-13342700,ymin:4084100,xmax:-13339988,ymax:4084700,spatialReference:{wkid:102100}});var a="mobile"==user_device||"tablet"==user_device?new esri.dijit.PopupMobile(null,dojo.create("div")):new esri.dijit.Popup(null,dojo.create("div"));map=new esri.Map("mapDiv",{extent:campusExtent,infoWindow:a});new esri.dijit.Scalebar({map:map,attachTo:"bottom-left"});dojo.connect(map,"onUpdateEnd",hideLoading);dojo.connect(map,"onUpdateStart",showLoading);
initLegend();initLayerLoader();ddtreemenu.createTree("layersmenu",!0);ddtreemenu.flatten("layersmenu","expand");dojo.connect(map,"onLoad",function(a){initParkingPopup();initBuildingPopup();initSearchModule_v2();initGeolocation(map);initBasemapGallery();dojo.connect(dijit.byId("mapDiv"),"resize",map,map.resize);dojo.connect(map,"onExtentChange",onMapExtentChange);document.getElementById("info").value=mapRootUrl;onMapExtentChange(map.extent,map._delta,"",map.__LOD);"mobile"==user_device&&window.toggleSidebar();
initShareLink()})}dojo.addOnLoad(init);function hideLoading(){benchmark.startTime=(new Date).getTime();document.getElementById("loadingImg").style.display="none"}function showLoading(){document.getElementById("loadingImg").style.display="block";benchmark.endTime=(new Date).getTime();console.log("Load Time: "+(benchmark.endTime-benchmark.startTime)+"ms.")}
function initLegend(){dojo.connect(map,"onLayersAddResult",function(a){legend._started?legend.refresh():(legend=new esri.dijit.Legend({map:map,layerInfos:legendLayers,respectCurrentMapScale:!0},"legendDiv"),legend.startup(),console.log("Legend module started."))})}function orientationChanged(){map&&(map.reposition(),map.resize())}function cleanArray(a){for(var b=[],c=0;c<a.length;c++)a[c]&&b.push(a[c]);return b}
function getLayerIDbyName(a,b){var c="";dojo.forEach(layers[a].layerInfos,function(a){a.name==b&&(c=a.id)});return c}
function onMapExtentChange(a,b,c,d){!1==sharelinkDialog.open&&updateShareLink();console.log("Extent updated in share link.");2E3>=d.scale&&"block"!=dojo.byId("floorSelectorDiv").style.display?(dojo.byId("floorSelectorDiv").style.display="block",console.log("Displaying the floor selector.")):2E3<d.scale&&"none"!=dojo.byId("floorSelectorDiv").style.display&&(dojo.byId("floorSelectorDiv").style.display="none",console.log("Hiding the floor selector."))}
function SelectAll(a){document.getElementById(a).focus();document.getElementById(a).select()}function parseGeometry(a){var b="";a=eval(a);1<a[0].length?(b=new esri.geometry.Polygon(new esri.SpatialReference({wkid:102100})),b.addRing(a[0])):"number"===typeof a[0].x&&"number"===typeof a[0].y&&(b=new esri.geometry.Point([a[0].x,a[0].y],new esri.SpatialReference({wkid:102100})));return b}var searchResultsGraphic,searchresultGraphicLayer,searchResults,searchResultClicked;
function zoomToSearchResults(a){"undefined"===typeof searchresultGraphicLayer&&(searchresultGraphicLayer=new esri.layers.GraphicsLayer({id:"searchresultGraphicLayer"}));map.addLayer(searchresultGraphicLayer);searchresultGraphicLayer.clear();addSearchResultGraphic(a);"point"===a.geometry.type?map.centerAndZoom(a.geometry,18):(map.centerAt(a.geometry.getExtent().getCenter()),map.setExtent(a.geometry.getExtent().expand(7),!0));searchresultGraphicLayer.show();searchResultClicked=a}
function addSearchResultGraphic(a){if("polygon"===a.geometry.type){var b=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([0,0,128]),2),new dojo.Color([0,0,128,0.4]));searchresultGraphicLayer.add(new esri.Graphic(a.geometry,b));textGeometry=a.geometry.getExtent().getCenter().offset(0,0.51*a.geometry.getExtent().getHeight())}"point"===a.geometry.type&&(b=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,
10,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([0,0,128]),2),new dojo.Color([0,0,128,0.4])),searchresultGraphicLayer.add(new esri.Graphic(a.geometry,b)),textGeometry=a.geometry.offset(0,25));a=a.location;b=new esri.symbol.Font("16pt",esri.symbol.Font.STYLE_NORMAL,esri.symbol.Font.VARIANT_NORMAL,esri.symbol.Font.WEIGHT_BOLD,"Helvetica");a=new esri.symbol.TextSymbol(a,b,new dojo.Color("black"));searchresultGraphicLayer.add(new esri.Graphic(textGeometry,a))}
function formatSearchResults(a,b){var c="",d="";searchResults[a]=[];for(i=0;i<b.results[a].count;i++){var e=0<i%2?"#E8E8E8":"white",f=b.results[a][i];if(null!=f.geometry&&"null"!=f.geometry){f.location!=f.label&&(d="\x3cbr /\x3e\x3cfont style\x3d'font-size:75%;'\x3e\x3ci\x3e("+f.location+")\x3c/i\x3e\x3c/font\x3e");var k=parseGeometry(f.geometry),c=c+"\x3cdiv style\x3d'margin:0;padding:0;width:100%; background:"+e+";'\x3e\x3ca href\x3d'#' onClick\x3d\"zoomToSearchResults(searchResults['"+a+"']['"+
i+"'])\"\x3e"+f.label+"\x3c/a\x3e"+d+"\x3c/div\x3e";f.geometry=k;searchResults[a][i]=f}else c=c+"\x3cdiv style\x3d'margin:0;padding:0;width:100%; background:"+e+";'\x3e"+f.label+"\x3cbr /\x3e\x3cfont style\x3d'font-size:75%;'\x3e\x3ci\x3e(Location Currently Unavailable)\x3c/i\x3e\x3c/font\x3e\x3c/div\x3e"}return c}var aContainer;
function showSearchResults(a){dojo.byId("searchResultMessage").innerHTML="";searchResults=[];dojo.byId("searchResultsExampleDiv").style.visibility="hidden";"undefined"!==typeof aContainer&&aContainer.destroyRecursive(!0);aContainer=new dijit.layout.AccordionContainer({style:"width: 99%; height:100%"},"searchResultsDiv");0<a.total_count?(console.log("Total Results: "+a.total_count+"."),aContainer.addChild(new dijit.layout.ContentPane({id:"resultsTitle",title:"Total Results ("+a.total_count+")",content:"Click one of the categories below to see the results."})),
"object"===typeof a.results.building&&0<a.results.building.count&&(console.log("Buildings found: "+a.results.building.count),aContainer.addChild(new dijit.layout.ContentPane({id:"buildingAccordionPane",title:"Buildings ("+a.results.building.count+")",content:formatSearchResults("building",a)}))),"object"===typeof a.results.department&&0<a.results.department.count&&(console.log("Departments found: "+a.results.department.count),aContainer.addChild(new dijit.layout.ContentPane({id:"departmentAccordionPane",
title:"Departments ("+a.results.department.count+")",content:formatSearchResults("department",a)}))),"object"===typeof a.results.people&&0<a.results.people.count&&(console.log("People found: "+a.results.people.count),aContainer.addChild(new dijit.layout.ContentPane({id:"peopleAccordionPane",title:"People ("+a.results.people.count+")",content:formatSearchResults("people",a)}))),"object"===typeof a.results.rooms&&0<a.results.rooms.count&&(console.log("Rooms found: "+a.results.rooms.count),aContainer.addChild(new dijit.layout.ContentPane({id:"roomsAccordionPane",
title:"Rooms ("+a.results.rooms.count+")",content:formatSearchResults("rooms",a)}))),"object"===typeof a.results["class"]&&0<a.results["class"].count&&(console.log("Classes found: "+a.results["class"].count),aContainer.addChild(new dijit.layout.ContentPane({id:"classAccordionPane",title:"Classes ("+a.results["class"].count+")",content:formatSearchResults("class",a)}))),"object"===typeof a.results.campusservice&&0<a.results.campusservice.count&&(console.log("Campus Services found: "+a.results.campusservice.count),
aContainer.addChild(new dijit.layout.ContentPane({id:"campusserviceAccordionPane",title:"Campus Services ("+a.results.campusservice.count+")",content:formatSearchResults("campusservice",a)}))),"object"===typeof a.results.parking&&0<a.results.parking.count&&(console.log("Parking Areas found: "+a.results.parking.count),aContainer.addChild(new dijit.layout.ContentPane({id:"parkingAccordionPane",title:"Parking Areas ("+a.results.parking.count+")",content:formatSearchResults("parking",a)}))),"object"===
typeof a.results.foodestablishments&&0<a.results.foodestablishments.count&&(console.log("Food Establishments found: "+a.results.foodestablishments.count),aContainer.addChild(new dijit.layout.ContentPane({id:"foodestablishmentsAccordionPane",title:"Food Establishments ("+a.results.foodestablishments.count+")",content:formatSearchResults("foodestablishments",a)}))),dojo.byId("searchBox")):(dojo.byId("searchResultMessage").innerHTML="\x3cbr /\x3e\x3cb\x3eNo Results Found\x3c/b\x3e\x3cbr /\x3eTry rephrasing your search.\x3cbr /\x3e\x3cbr /\x3e",
dojo.byId("searchResultsExampleDiv").style.visibility="visible");aContainer.startup()}function initSearchModule_v2(){dojo.ready(function(){var a=dijit.byId("searchForm"),b=dijit.byId("searchBox");dojo.connect(a,"onSubmit",function(a){dojo.stopEvent(a);dojo.xhrGet({url:"/api.php?action\x3dsearchboxSearch\x26searchText\x3d"+b.get("value"),handleAs:"json",load:showSearchResults})})})}var urlValues,shareLink;
function finishShareLink(){console.log("Parsing Geometry from urlValues");var a=searchResultClicked.geometry;if("polygon"===a.type){var b=new esri.geometry.Polygon(new esri.SpatialReference({wkid:102100}));b.addRing(a.rings[0])}else alert("Not a valid shortcut format in the URL.");searchResultClicked.geometry=b;setTimeout(function(){console.log("Activating search result based on URL.");zoomToSearchResults(searchResultClicked)},1E3)}
function initShareLink(){urlValues=dojo.queryToObject(dojo.doc.location.search.substr("?"===dojo.doc.location.search[0]?1:0));var a=parseFloat(urlValues.xmin),b=parseFloat(urlValues.ymin),c=parseFloat(urlValues.xmax),d=parseFloat(urlValues.ymax);if(!isNaN(a)&&!isNaN(b)&&!isNaN(c)&&!isNaN(d)){var e=new esri.geometry.Extent(a,b,c,d,new esri.SpatialReference({wkid:102100}));map.setExtent(e)}"undefined"!==typeof urlValues.searchResult&&(searchResultClicked=dojo.json.parse(decodeURI(urlValues.searchResult)),
"undefined"===typeof searchResultClicked.geometry?dojo.xhrGet({url:"/api.php?action\x3dgetRoomGeometry\x26searchText\x3d"+searchResultClicked.location,handleAs:"json",load:function(a){a.results[0].geometry=eval("["+a.results[0].geometry+"]");searchResultClicked.geometry=a.results[0].geometry[0];searchResultClicked.geometry.type="polygon";finishShareLink()}}):finishShareLink());getParameter("activelayer")&&(activeLayer=getParameter("activelayer"),setTimeout(function(){"undefined"!=typeof e&&map.setExtent(e);
console.log('Activating layer "'+activeLayer+'" based on URL.');addLayer(activeLayer)},1E3))}
function updateShareLink(){var a=map.extent,b="",c=[],b=b=b="";"undefined"!=typeof layersActive&&(""!=layersActive[0]&&"basemap"!=layersActive[0]&&"undefined"!=typeof layersActive[0]&&!0==dojo.byId(sharelinkCurrentLayer).checked)&&(b="activelayer\x3d"+layersActive[0],c.push(b));"undefined"!=typeof searchResultClicked&&(""!=searchResultClicked&&!0==dojo.byId(sharelinkSearchResult).checked)&&(b=dojo.clone(searchResultClicked),delete b.searchScore,b="searchResult\x3d"+dojo.json.stringify(b),c.push(b));
!0==dojo.byId(sharelinkExactExtent).checked&&(b="xmin\x3d"+a.xmin.toFixed(0)+"\x26ymin\x3d"+a.ymin.toFixed(0)+"\x26xmax\x3d"+a.xmax.toFixed(0)+"\x26ymax\x3d"+a.ymax.toFixed(0),c.push(b));b=mapRootUrl;"undefined"!==typeof c[0]&&(b=b+"?"+c.join("\x26"));console.log("Updating share link..");shareLink=document.getElementById("info").value=b}
function roomZoomerURL(){function a(a,b){var c=dojo.byId("list2");if(c)for(;c.firstChild;)c.removeChild(c.firstChild)}function b(a,b){var c=dojo.byId("list2");if(c){var d;for(d=0;d<a.length;d++){var e=a[d];c.appendChild(document.createTextNode(roomStore.getValue(e,"fips")))}c=roomStore.getValue(e,"fips");roomStore.fetchItemByIdentity({identity:c,onItem:function(a,b){newExtent=esri.geometry.geographicToWebMercator(a.extent[0]);openingExtent=newExtent.expand(25);setTimeout(function(){showExtentRoom(newExtent)},
1E3)},onError:function(a,b){oops()}})}}function c(a){openingExtent=new esri.geometry.Extent(-13342421,4083203,-13340163,4085223,new esri.SpatialReference({wkid:102100}));alert("Lookup failed. Use the Room Locator to verify building name and room are valid entries.  Not all buildings are supported at this time.");alert(a);startMap()}console.log("Zooming to specified room from shared link.");var d=getParameter("room").toString(),e=getParameter("bldg"),e=unescape(e);!1==e?alert("Bldg parameter is missing. Use the room locator to build a valid link to a room."):
roomStore.fetch({query:{name:d,bldg_name:e},onBegin:a,onComplete:b,onError:c,queryOptions:{deep:!0}})}function getTinyurl(a){query=[];query.action="shorturl";query.signature="23c021268c";query.format="json";query.url=encodeURI(a);apiUrl="/api.php?"+dojo.objectToQuery(query);dojo.xhrGet({url:apiUrl,handleAs:"json",load:function(a){document.getElementById("info").value=a.shorturl}})}
function getParameter(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");a=RegExp("[\\?\x26]"+a+"\x3d([^\x26#]*)").exec(window.location.href);return null==a?"":a[1]}var hoverGraphicsLayerBus,hoverGraphicsLayerFloor,hoverGraphicsLayerParking,hoverGraphicsLayer;
function initParkingPopup(){hoverGraphicsLayerParking=new esri.layers.GraphicsLayer;var a=new esri.tasks.QueryTask("http://map.geog.ucsb.edu:8080/arcgis/rest/services/icm/parkingNumberedLots/MapServer/0"),b=new esri.tasks.Query;b.returnGeometry=!0;b.outFields="Lot_Number T1 T2 T3 T4 T5 T6 T7 T8 T9 T10 T11 T12 T13 T14 T15 T16".split(" ");b.where="1\x3d1";var c=new esri.InfoTemplate;c.setTitle("${Lot_Number} ");c.setContent("\x3cb\x3e${T1} \x3c/b\x3e\x3cbr\x3e\x3cbr\x3eNumber of Parking Spaces:\x3cbr\x3e\x3cbr\x3e${T2}\x3cbr\x3e${T3}\x3cbr\x3e${T4}\x3cbr\x3e${T5} \x3cbr\x3e${T6} \x3cbr\x3e${T7} \x3cbr\x3e${T8} \x3cbr\x3e${T9} \x3cbr\x3e${T10} \x3cbr\x3e${T11}\x3cbr\x3e${T12} \x3cbr\x3e${T13} \x3cbr\x3e${T14} \x3cbr\x3e${T15} \x3cbr\x3e${T16} \x3cbr\x3e\x3cbr\x3e\x3csmall\x3eFor official parking information refer to \x3ca href\x3d'http://www.tps.ucsb.edu/'\x3e UCSB Transportation and Parking Services.\x3c/a\x3e\x3c/small\x3e");
dojo.connect(a,"onComplete",function(a){for(var b=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([0,0,0,0])),new dojo.Color([0,0,128,0])),f=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([0,0,128]),2),new dojo.Color([0,0,128,0.4])),k=0,l=a.features.length;k<l;k++){var h=
a.features[k];h.setSymbol(b);h.setInfoTemplate(c);hoverGraphicsLayerParking.add(h)}map.addLayer(hoverGraphicsLayerParking);map.graphics.enableMouseEvents();dojo.connect(hoverGraphicsLayerParking,"onClick",function(a){map.infoWindow.resize(350,250);map.graphics.clear();a.graphic.getContent();a.graphic.getTitle();var b=new esri.Graphic(a.graphic.geometry,f);map.graphics.add(b);("mobile"==user_device||"tablet"==user_device)&&map.infoWindow.setFeatures([a.graphic])});dojo.connect(hoverGraphicsLayerParking,
"onMouseOver",function(){map.setCursor("pointer")});dojo.connect(hoverGraphicsLayerParking,"onMouseOut",function(){map.setCursor("default")})});a.execute(b)}var hoverGraphicsLayerBuilding;
function initBuildingPopup(){var a="11.11.11.11"===window.location.hostname?"http://map.geog.ucsb.edu/":"";dojo.connect(map.infoWindow,"onMaximize",function(){resizeBuildingPic("full");console.log("Info Window Maximized")});dojo.connect(map.infoWindow,"onRestore",function(){resizeBuildingPic("thumb");console.log("Info Window Restored to default state.")});hoverGraphicsLayerBuilding=new esri.layers.GraphicsLayer({id:"infowindow_buildings"});var b=getLayerIDbyName("basemap","Buildings"),b=checkQueryURL(layersConfig.basemap)+
"/"+b,b=new esri.tasks.QueryTask(b),c=new esri.tasks.Query;c.returnGeometry=!0;c.outFields=["bl_num","b_name","department"];c.where="1\x3d1";var a="\x3cb\x3eBuilding #:\x3c/b\x3e ${bl_num}\x3ca href\x3d'"+a+"images/i/bldg_${bl_num}/?ref\x3dbldg_infowindow' target\x3d'_blank'\x3e\x3cimg id\x3d'infoWindow_bldgPic' align\x3d'right' src\x3d'"+a+"images/i/bldg_${bl_num}/thumb/?ref\x3dbldg_infowindow' style\x3d'float: right; margin: 2px; max-width:50%; min-width:0px; min-height:0px;'\x3e\x3c/a\x3e\x3cp\x3e${department}\x3c/p\x3e\x3cp\x3e\x3ca href\x3d'#' onclick\x3d'loadEnergyUsage(${bl_num}, \"${b_name}\")'\x3e\x3cimg src\x3d'images/iconChart_small.png' style\x3d'padding-right:5px'/\x3eView Energy Usage\x3c/a\x3e\x3c/p\x3e",
d=new esri.InfoTemplate;d.setTitle("${b_name}\x3cimg src\x3d'/images/trans1x1.png'\x3e\x3c/img\x3e");d.setContent(a);dojo.connect(b,"onComplete",function(a){for(var b=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([0,0,0,0])),new dojo.Color([0,0,128,0])),c=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,
new dojo.Color([115,255,223]),3),new dojo.Color([115,225,223,0.05])),l=0,h=a.features.length;l<h;l++){var g=a.features[l];g.setSymbol(b);g.setInfoTemplate(d);null==g.attributes.bl_num&&(g.attributes.bl_num="unidentified");if(null!=g.attributes.department&&" "!=g.attributes.department&&""!=g.attributes.department){for(var p=g.attributes.department.split(";"),m="\x3cb\x3eDepartments:\x3c/b\x3e \x3cbr /\x3e",n=0,q=p.length;n<q;++n)m+='\x3ca href\x3d"'+getDeptUrl(p[n])+'" target\x3d"_blank"\x3e',m+=p[n]+
"\x3c/a\x3e\x3cbr /\x3e";g.attributes.department=m}hoverGraphicsLayerBuilding.add(g)}map.addLayer(hoverGraphicsLayerBuilding);map.graphics.enableMouseEvents();dojo.connect(hoverGraphicsLayerBuilding,"onClick",function(a){map.infoWindow.resize(350,450);map.graphics.clear();a.graphic.getContent();a.graphic.getTitle();var b=new esri.Graphic(a.graphic.geometry,c);map.graphics.add(b);("mobile"==user_device||"tablet"==user_device)&&map.infoWindow.setFeatures([a.graphic])});dojo.connect(hoverGraphicsLayerBuilding,
"onMouseOver",function(a){a.graphic.setSymbol(c);map.setCursor("pointer")});dojo.connect(hoverGraphicsLayerBuilding,"onMouseOut",function(a){map.graphics.clear();a.graphic.setSymbol(b);map.setCursor("default")})});b.execute(c)}function resizeBuildingPic(a){var b=document.getElementById("infoWindow_bldgPic").src;if("full"==a)var c=b.replace("_Thumbs","_Resized");"thumb"==a&&(c=b.replace("_Resized","_Thumbs"));document.getElementById("infoWindow_bldgPic").src=c}
function getDeptUrl(a){switch(a){case "Anthropology":return"http://www.anth.ucsb.edu/";case "Asian American Studies":return"http://www.asamst.ucsb.edu/";case "Classics":return"http://www.classics.ucsb.edu/";case "East Asian Languages and Cultural Studies":return"http://www.eastasian.ucsb.edu/";case "History":return"http://www.history.ucsb.edu/";case "Religious Studies":return"http://www.religion.ucsb.edu/";case "Art":return"http://www.arts.ucsb.edu/";case "Biomolecular Science and Engineering":return"http://www.bmse.ucsb.edu/";
case "Biological Sciences":return"#";case "Ecology, Evolution and Marine Biology":return"http://lifesci.ucsb.edu/EEMB/";case "Marine Science":return"http://marinegp.ucsb.edu/";case "Molecular, Cellular and Developmental Biology":return"http://lifesci.ucsb.edu/MCDB/";case "Black Studies":return"http://www.blackstudies.ucsb.edu/";case "Chicano Studies":return"http://www.chicst.ucsb.edu/";case "English":return"http://www.english.ucsb.edu/";case "Feminist Studies":return"http://www.femst.ucsb.edu/";case "Linguistics":return"http://www.linguistics.ucsb.edu/";
case "Mathematics":return"http://www.math.ucsb.edu/ie_index.html";case "Philosophy":return"http://www.philosophy.ucsb.edu/";case "Statistics":return"http://www.pstat.ucsb.edu/";case "Writing":return"http://www.writing.ucsb.edu/";case "Chemical Engineering":return"http://www.chemengr.ucsb.edu/";case "Materials":return"http://www.materials.ucsb.edu/";case "Mechanical Engineering":return"http://www.me.ucsb.edu/";case "Communication":return"http://www.comm.ucsb.edu/";case "Film and Media Studies":return"http://www.filmandmedia.ucsb.edu/";
case "Global and International Studies":return"http://www.global.ucsb.edu/";case "Sociology":return"http://www.soc.ucsb.edu/";case "Comparative Literature":return"http://www.complit.ucsb.edu/";case "French and Italian":return"http://www.frit.ucsb.edu/";case "Germanic, Slavic, and Semitic Studies":return"http://www.gss.ucsb.edu/";case "Media Arts and Technology":return"http://www.mat.ucsb.edu/";case "Spanish and Portugese":return"http://www.spanport.ucsb.edu/";case "Computer Science":return"http://www.cs.ucsb.edu/";
case "Electrical Engineering":return"http://www.ece.ucsb.edu/";case "Counseling, Clinical, and School Psychology":return"http://education.ucsb.edu/Graduate-Studies/CCSP/CCSP-home.html";case "Education":return"http://education.ucsb.edu/Graduate-Studies/Education/home.htm";case "Dance":return"http://www.theaterdance.ucsb.edu/";case "Earth Science":return"http://www.geol.ucsb.edu/";case "Economics":return"http://www.econ.ucsb.edu/";case "Environmental Studies":return"http://www.es.ucsb.edu/";case "Bren School":return"http://www.bren.ucsb.edu/";
case "Geography":return"http://www.geog.ucsb.edu/";case "Political Science":return"http://www.polsci.ucsb.edu/";case "History of Art and Architecture":return"http://www.arthistory.ucsb.edu/";case "Military Science (ROTC)":return"http://www.milsci.ucsb.edu/";case "Music":return"http://www.music.ucsb.edu/";case "Physics":return"http://www.physics.ucsb.edu/";case "Psychological and Brain Science":return"http://www.psych.ucsb.edu/";case "Theater":return"http://www.theaterdance.ucsb.edu/"}}
var persisteduls={},ddtreemenu={};ddtreemenu.closefolder=mapRootUrl+"images/simpletree/transparent.png";ddtreemenu.openfolder=mapRootUrl+"images/simpletree/transparent.png";
ddtreemenu.createTree=function(a,b,c){var d=document.getElementById(a).getElementsByTagName("ul");"undefined"==typeof persisteduls[a]&&(persisteduls[a]=!0==b&&""!=ddtreemenu.getCookie(a)?ddtreemenu.getCookie(a).split(","):"");for(var e=0;e<d.length;e++)ddtreemenu.buildSubTree(a,d[e],e);if(!0==b){var f="undefined"==typeof c?1:parseInt(c);ddtreemenu.dotask(window,function(){ddtreemenu.rememberstate(a,f)},"unload")}};
ddtreemenu.buildSubTree=function(a,b,c){b.parentNode.className="submenu";"object"==typeof persisteduls[a]?ddtreemenu.searcharray(persisteduls[a],c)?(b.setAttribute("rel","open"),b.style.display="block",b.parentNode.style.backgroundImage="url("+ddtreemenu.openfolder+")"):b.setAttribute("rel","closed"):null==b.getAttribute("rel")||!1==b.getAttribute("rel")?b.setAttribute("rel","closed"):"open"==b.getAttribute("rel")&&ddtreemenu.expandSubTree(a,b);b.parentNode.onclick=function(a){var c=this.getElementsByTagName("ul")[0];
"closed"==c.getAttribute("rel")?(c.style.display="block",c.setAttribute("rel","open"),b.parentNode.style.backgroundImage="url("+ddtreemenu.openfolder+")"):"open"==c.getAttribute("rel")&&(c.style.display="none",c.setAttribute("rel","closed"),b.parentNode.style.backgroundImage="url("+ddtreemenu.closefolder+")");ddtreemenu.preventpropagate(a)};b.onclick=function(a){ddtreemenu.preventpropagate(a)}};
ddtreemenu.expandSubTree=function(a,b){var c=document.getElementById(a),d=b;d.style.display="block";for(d.parentNode.style.backgroundImage="url("+ddtreemenu.openfolder+")";d!=c;)"UL"==d.tagName&&(d.style.display="block",d.setAttribute("rel","open"),d.parentNode.style.backgroundImage="url("+ddtreemenu.openfolder+")"),d=d.parentNode};
ddtreemenu.flatten=function(a,b){for(var c=document.getElementById(a).getElementsByTagName("ul"),d=0;d<c.length;d++)c[d].style.display="expand"==b?"block":"none",c[d].setAttribute("rel","expand"==b?"open":"closed"),c[d].parentNode.style.backgroundImage="expand"==b?"url("+ddtreemenu.openfolder+")":"url("+ddtreemenu.closefolder+")"};
ddtreemenu.rememberstate=function(a,b){for(var c=document.getElementById(a).getElementsByTagName("ul"),d=[],e=0;e<c.length;e++)"open"==c[e].getAttribute("rel")&&(d[d.length]=e);0==d.length&&(d[0]="none open");ddtreemenu.setCookie(a,d.join(","),b)};ddtreemenu.getCookie=function(a){a=RegExp(a+"\x3d[^;]+","i");return document.cookie.match(a)?document.cookie.match(a)[0].split("\x3d")[1]:""};
ddtreemenu.setCookie=function(a,b,c){var d=new Date;d.setDate(d.getDate()+parseInt(c));document.cookie=a+"\x3d"+b+"; expires\x3d"+d.toGMTString()+"; path\x3d/"};ddtreemenu.searcharray=function(a,b){for(var c=!1,d=0;d<a.length;d++)if(a[d]==b){c=!0;a.shift();break}return c};ddtreemenu.preventpropagate=function(a){"undefined"!=typeof a?a.stopPropagation():event.cancelBubble=!0};
ddtreemenu.dotask=function(a,b,c){c=window.addEventListener?c:"on"+c;a.addEventListener?a.addEventListener(c,b,!1):a.attachEvent&&a.attachEvent(c,b)};var layers=[],layersActive=[],layersConfig=[],infowindowGraphicsLayer=[];function initLayerLoader(){dojo.xhrGet({url:"/data/layers.json.php",handleAs:"json",load:gotLayersJSON})}function gotLayersJSON(a){console.log("Got layers.json.");dojo.forEach(a,function(a){layersConfig[a.id]=a;"basemap"==a.id&&addLayer("basemap")})}
function addLayer(a){if("undefined"==typeof layers[a]||"boolean"!=typeof layers[a].loaded)"undefined"==typeof layersConfig[a]&&(console.log(a+" was not included in the default layers config.  Will attempt to load it dynamically."),dojo.xhrGet({url:"/data/layers.json.php?layers\x3d"+a,handleAs:"json",sync:!0,load:gotLayersJSON})),layers[a]=initJSONLayer(layersConfig[a]);if(-1==dojo.indexOf(layersActive,a)){map.addLayers([layers[a]]);if("basemap"!=layers[a].id){if("SBMTD"==layers[a].id||"webcams"==
layers[a].id)layers.esriBasemapCanvas=new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer",{id:"esriBasemapCanvas"}),layers.esriBasemapCanvasRef=new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer",{id:"esriBasemapCanvas"}),console.log("Adding ESRI Grey Basemap"),map.addLayer(layers.esriBasemapCanvas,0),console.log("Adding ESRI Grey Basemap Reference"),
map.addLayer(layers.esriBasemapCanvasRef,1);legendLayers.push({layer:layers[a],title:" "})}else map.addLayer(layers[a]);layers[a].setVisibility(!0);if(null!=layersConfig[a].infowindow){var b=0;dojo.forEach(layersConfig[a].infowindow,function(c){initLayerPopup(a,b);b++})}console.log('Activated "'+layers[a].id+'".');layersActive.unshift(layers[a].id)}else console.log('Layer "'+a+'" already active.');updateShareLink();dojo.connect(layers[a],"onResume",function(b){1==layersConfig[a].zoomOnLoad&&map.setExtent(layers[a].fullExtent.expand(1.5));
2==layersConfig[a].zoomOnLoad&&map.setExtent(campusExtent);null!=typeof layersConfig[a].mapOverlay&&""!=layersConfig[a].mapOverlay?(dojo.byId("mapOverlayDiv").style.visibility="visible",dojo.byId("mapOverlayDiv").innerHTML=layersConfig[a].mapOverlay):(dojo.byId("mapOverlayDiv").style.display="hidden",dojo.byId("mapOverlayDiv").innerHTML="");1==layersConfig[a].openLegendOnLoad&&dijit.byId("mainAccordionCont").selectChild(dijit.byId("pane_Legend"));legend._started&&legend.refresh()})}
function initJSONLayer(a){if("undefined"==typeof a)return!1;if(void 0==typeof a.opacity||isNaN(a.opacity)||null==a.opacity)a.opacity=1;if("dynamic"==a.type)var b=new esri.layers.ArcGISDynamicMapServiceLayer(a.url,{id:a.id,opacity:a.opacity});"featureservice"==a.type&&(dojo.require("esri.layers.FeatureLayer"),b=new esri.layers.FeatureLayer(a.url,{id:a.id,opacity:a.opacity,mode:esri.layers.FeatureLayer.MODE_ONDEMAND}));"cached"==a.type&&(b=new esri.layers.ArcGISTiledMapServiceLayer(a.url,{id:a.id,opacity:a.opacity}));
"kml"==a.type&&(b=a.url+"?nocache\x3d"+(new Date).getTime(),b=new esri.layers.KMLLayer(b,{id:a.id,opacity:a.opacity}));console.log('Layer "'+a.id+'" initialized from layers.json."');return b}
function initLayerPopup(a,b){infowindowGraphicsLayer[a]=new esri.layers.GraphicsLayer;var c=0<=parseInt(layersConfig[a].infowindow[b].layerID)?new esri.tasks.QueryTask(checkQueryURL(layersConfig[a])+"/"+layersConfig[a].infowindow[b].layerID):new esri.tasks.QueryTask(layersConfig[a].infowindow[b].layerID),d=new esri.tasks.Query;d.returnGeometry=!0;d.outFields=["*"];d.where="1\x3d1";d.geometryPrecision=1;var e=new esri.InfoTemplate;e.setTitle(layersConfig[a].infowindow[b].infowindowTitle);e.setContent(layersConfig[a].infowindow[b].infowindowContent);
dojo.connect(c,"onComplete",function(b){for(var c=0,d=b.features.length;c<d;c++){var h=b.features[c];if("esriGeometryPolygon"==b.geometryType){var g=new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([0,0,0,0])),new dojo.Color([0,0,128,0]));new esri.symbol.SimpleFillSymbol(esri.symbol.SimpleFillSymbol.STYLE_SOLID,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,
new dojo.Color([0,0,128]),2),new dojo.Color([0,0,128,0.4]))}"esriGeometryPoint"==b.geometryType&&(g=new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,30,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([0,0,0,0]),2),new dojo.Color([255,255,255,0])),new esri.symbol.SimpleMarkerSymbol(esri.symbol.SimpleMarkerSymbol.STYLE_CIRCLE,30,new esri.symbol.SimpleLineSymbol(esri.symbol.SimpleLineSymbol.STYLE_SOLID,new dojo.Color([0,0,0,0]),2),
new dojo.Color([255,255,255,0])));h.setSymbol(g);h.setInfoTemplate(e);infowindowGraphicsLayer[a].add(h)}map.addLayer(infowindowGraphicsLayer[a]);map.graphics.enableMouseEvents();dojo.connect(infowindowGraphicsLayer[a],"onClick",function(a){map.graphics.clear();a.graphic.getContent();a.graphic.getTitle();("mobile"==user_device||"tablet"==user_device)&&map.infoWindow.setFeatures([a.graphic])});dojo.connect(infowindowGraphicsLayer[a],"onMouseOver",function(){map.setCursor("pointer")});dojo.connect(infowindowGraphicsLayer[a],
"onMouseOut",function(){map.setCursor("default")})});c.execute(d)}
function clearLayers(){dojo.byId("mapOverlayDiv").innerHTML="";dojo.byId("mapOverlayDiv").style.visibility="hidden";0<layersActive.length&&(dojo.forEach(layersActive,function(a){"basemap"!=layers[a].id&&(layers[a].setVisibility(!1),infowindowGraphicsLayer[a]&&infowindowGraphicsLayer[a].clear())}),layersActive=[],legendLayers.length=0);if(layers.esriBasemapCanvas||layers.esriBasemapCanvasRef)map.removeLayer(layers.esriBasemapCanvas),map.removeLayer(layers.esriBasemapCanvasRef);"object"===typeof searchresultGraphicLayer&&
map.removeLayer(searchresultGraphicLayer);legend._started&&legend.refresh();searchResultClicked=""}function changeLayer(a){-1==dojo.indexOf(layersActive,a)||"customlayer"===a?(clearLayers(),setTimeout(addLayer(a),1E3),dojo.xhrPost({url:"/api.php",content:{action:"layerLoaded",layer:a}})):console.log('Layer "'+layers[a].id+'" already active.');legend._started&&legend.refresh()}function checkQueryURL(a){return"string"!==typeof a.query_url||0===a.query_url.length?a.url:a.query_url}
function addCustomLayer(){var a=document.getElementById("addcustomlayer_URL").value,b=document.getElementById("addcustomlayer_Type").value,b=dojo.fromJson('{"id": "customlayer","url": "'+a+'","type": "'+b+'", "opacity": 1}');layersConfig.customlayer=b;console.log(checkCustomURLType(a));changeLayer("customlayer")}
function checkCustomURLType(a){clearLayers();if(".KML"===a.substring(a.length-4,a.length).toUpperCase()||".KMZ"===a.substring(a.length-4,a.length).toUpperCase())document.getElementById("addcustomlayer_Type").options[2].selected=!0,document.getElementById("addcustomlayer_Type").selectedIndex=2,console.log("Layer is a KML based on the URL.");"MAPSERVER"===a.substring(a.length-9,a.length).toUpperCase()&&console.log("Layer is a ArcGIS Layer based on the URL.")}var energyData=[];
function loadEnergyUsage(a,b){var c="/api.php?action\x3dgetEnergyData\x26returnOnlyData\x3dtrue\x26ts\x3d"+(new Date).getTime()+"\x26bldgNumber\x3d"+a;dojo.xhrGet({url:c,handleAs:"json",load:function(c){null!=c?(drawEnergyChart(c,b,a),energyData[a]=[],energyData[a].bname=b,energyData[a].bnumber=a,energyData[a].data=c):alert("Energy data current not available for "+b+".\nPlease check back later.")},error:function(a){alert("An unexpected error occurred: "+a)}})}
function drawEnergyChart(a,b,c){energydashboardDialog.show();$(function(){window.chart=new Highcharts.StockChart({chart:{renderTo:"energycontainer",backgroundColor:"#F7F7F7"},rangeSelector:{selected:4},title:{text:b+" Electricity Usage (kWh)",align:"left"},series:[{name:"Electricity Usage (kWh)",data:a,tooltip:{valueDecimals:0}}],yAxis:[{min:0,minorTickInterval:"auto"}],xAxis:[{gridLineWidth:1,lineColor:"#000",tickColor:"#000",tickInterval:2592E6}]})})}dojo.require("esri.dijit.Print");var printDijit;
function initPrintModule(){esri.config.defaults.io.proxyUrl="/data/proxy.php";printDijit=new esri.dijit.Print({map:map,url:"http://map.geog.ucsb.edu:8080/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task",templates:[{label:"PDF (Landscape)",format:"PDF",layout:"A4 Landscape",preserveScale:!1,layoutOptions:{titleText:"University of California, Santa Barbara",authorText:"UCSB Geography Department",copyrightText:"University of California",scalebarUnit:"Miles"}},{label:"PDF (Portrait)",
format:"PDF",layout:"A4 Portrait",preserveScale:!1,layoutOptions:{titleText:"University of California, Santa Barbara",authorText:"UCSB Geography Department",copyrightText:"University of California",scalebarUnit:"Miles"}},{label:"Export as Image (PNG)",format:"PNG32",layout:"MAP_ONLY",preserveScale:!1,exportOptions:{width:1024,height:768,dpi:96}}]},dojo.byId("printButton"));printDijit.startup();dojo.connect(printDijit,"onPrintComplete",function(a){alert("The printout will open in a new window.  If you don't see it, try temporarily disabling your popup blocker.");
window.open(a.url,"_blank");printDijit.destroy();initPrintModule()})};